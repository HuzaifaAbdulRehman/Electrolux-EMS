'use client';

import React, { useState } from 'react';
import { useSession } from 'next-auth/react';

import DashboardLayout from '@/components/DashboardLayout';
import {
  Gauge,
  Calendar,
  Clock,
  MapPin,
  Phone,
  FileText,
  Send,
  CheckCircle,
  AlertCircle,
  User,
  Zap,
  History,
  Eye,
  XCircle
} from 'lucide-react';

export default function RequestReading() {
  const { data: session } = useSession();

  const [formData, setFormData] = useState({
    requestType: 'regular',
    preferredDate: '',
    preferredTimeSlot: 'morning',
    contactPhone: '+1234567890',
    alternatePhone: '',
    accessInstructions: '',
    urgency: 'normal'
  });

  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showSuccess, setShowSuccess] = useState(false);
  const [requestId, setRequestId] = useState('');

  // Customer account info (would come from backend)
  const accountInfo = {
    accountNumber: 'ELX-2024-001234',
    customerName: 'Huzaifa',
    address: '123 Main Street, Apt 4B, Downtown, City 12345',
    meterNumber: 'MTR-485729',
    lastReading: 12485,
    lastReadingDate: '2024-09-10',
    zone: 'Zone-A'
  };

  // Previous requests (mock data)
  const previousRequests = [
    {
      id: 1,
      requestNumber: 'REQ-2024-001',
      requestedDate: '2024-10-01',
      preferredDate: '2024-10-05',
      status: 'completed',
      assignedTo: 'Mike Johnson',
      completedDate: '2024-10-05',
      readingTaken: 12485
    },
    {
      id: 2,
      requestNumber: 'REQ-2024-002',
      requestedDate: '2024-09-01',
      preferredDate: '2024-09-05',
      status: 'completed',
      assignedTo: 'Sarah Smith',
      completedDate: '2024-09-04',
      readingTaken: 12020
    },
    {
      id: 3,
      requestNumber: 'REQ-2024-003',
      requestedDate: '2024-08-01',
      preferredDate: '2024-08-05',
      status: 'completed',
      assignedTo: 'Mike Johnson',
      completedDate: '2024-08-05',
      readingTaken: 11540
    }
  ];

  const requestTypes = [
    { value: 'regular', label: 'Regular Reading', description: 'Standard monthly meter reading' },
    { value: 'urgent', label: 'Urgent Reading', description: 'Need reading within 24 hours' },
    { value: 'disputed', label: 'Disputed Bill', description: 'Request reading for bill verification' },
    { value: 'final', label: 'Final Reading', description: 'Closing account or moving out' }
  ];

  const timeSlots = [
    { value: 'morning', label: 'Morning (8 AM - 12 PM)' },
    { value: 'afternoon', label: 'Afternoon (12 PM - 4 PM)' },
    { value: 'evening', label: 'Evening (4 PM - 7 PM)' },
    { value: 'anytime', label: 'Anytime (Flexible)' }
  ];

  const urgencyLevels = [
    { value: 'low', label: 'Low Priority', color: 'from-green-500 to-emerald-500', description: 'Within 7 days' },
    { value: 'normal', label: 'Normal Priority', color: 'from-blue-500 to-cyan-500', description: 'Within 3-5 days' },
    { value: 'high', label: 'High Priority', color: 'from-yellow-400 to-orange-500', description: 'Within 1-2 days' },
    { value: 'urgent', label: 'Urgent', color: 'from-red-500 to-pink-500', description: 'Within 24 hours' }
  ];

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    // Simulate API call
    setTimeout(() => {
      const newRequestId = `REQ-2024-${String(Math.floor(Math.random() * 9000) + 1000)}`;
      setRequestId(newRequestId);
      setIsSubmitting(false);
      setShowSuccess(true);

      // Reset form after 5 seconds
      setTimeout(() => {
        setShowSuccess(false);
        setFormData({
          requestType: 'regular',
          preferredDate: '',
          preferredTimeSlot: 'morning',
          contactPhone: '+1234567890',
          alternatePhone: '',
          accessInstructions: '',
          urgency: 'normal'
        });
      }, 5000);
    }, 2000);
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-500/20 text-green-400 border-green-500/50';
      case 'in_progress': return 'bg-blue-500/20 text-blue-400 border-blue-500/50';
      case 'pending': return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/50';
      case 'cancelled': return 'bg-red-500/20 text-red-400 border-red-500/50';
      default: return 'bg-gray-500/20 text-gray-400 border-gray-500/50';
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'completed': return <CheckCircle className="w-4 h-4" />;
      case 'in_progress': return <Clock className="w-4 h-4" />;
      case 'pending': return <AlertCircle className="w-4 h-4" />;
      case 'cancelled': return <XCircle className="w-4 h-4" />;
      default: return <Clock className="w-4 h-4" />;
    }
  };

  return (
    <DashboardLayout userType="customer" userName={session?.user?.name || 'Customer'}>
      <div className="h-full flex flex-col overflow-hidden">
        {/* Header */}
        <div className="bg-white dark:bg-white/5 backdrop-blur-xl rounded-2xl p-4 border border-gray-200 dark:border-white/10 mb-4 flex-shrink-0">
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900 dark:text-white mb-1 flex items-center">
                <Gauge className="w-6 h-6 mr-2 text-purple-400" />
                Request Meter Reading
              </h1>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                Schedule a meter reading visit from our field team
              </p>
            </div>
          </div>
        </div>

        {/* Main Content */}
        <div className="flex-1 min-h-0 overflow-y-auto">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
            {/* Left Column - Form */}
            <div className="lg:col-span-2 space-y-4">
              {/* Success Message */}
              {showSuccess && (
                <div className="bg-gradient-to-r from-green-500/20 to-emerald-500/20 backdrop-blur-xl rounded-2xl p-5 border border-green-500/50">
                  <div className="flex items-center space-x-3 mb-3">
                    <div className="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center">
                      <CheckCircle className="w-7 h-7 text-green-400" />
                    </div>
                    <div>
                      <h3 className="text-lg font-bold text-gray-900 dark:text-white">Request Submitted Successfully!</h3>
                      <p className="text-sm text-gray-700 dark:text-gray-300">
                        Your meter reading request has been received and assigned to a field employee.
                      </p>
                    </div>
                  </div>
                  <div className="p-4 bg-white dark:bg-white/5 rounded-lg border border-green-500/20">
                    <div className="grid grid-cols-2 gap-3 text-sm">
                      <div>
                        <p className="text-gray-600 dark:text-gray-400">Request Number</p>
                        <p className="text-gray-900 dark:text-white font-bold">{requestId}</p>
                      </div>
                      <div>
                        <p className="text-gray-600 dark:text-gray-400">Status</p>
                        <p className="text-yellow-400 font-semibold">Pending Assignment</p>
                      </div>
                      <div>
                        <p className="text-gray-600 dark:text-gray-400">Preferred Date</p>
                        <p className="text-gray-900 dark:text-white font-semibold">{formData.preferredDate}</p>
                      </div>
                      <div>
                        <p className="text-gray-600 dark:text-gray-400">Expected Assignment</p>
                        <p className="text-gray-900 dark:text-white font-semibold">Within 2 hours</p>
                      </div>
                    </div>
                  </div>
                  <p className="text-xs text-gray-700 dark:text-gray-300 mt-3">
                    You will receive a notification once an employee is assigned to your request.
                  </p>
                </div>
              )}

              {/* Account Information */}
              <div className="bg-gradient-to-r from-purple-500/10 to-pink-500/10 backdrop-blur-xl rounded-2xl p-5 border border-purple-500/20">
                <h2 className="text-base font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                  <User className="w-4 h-4 mr-2" />
                  Account Information
                </h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="flex items-start space-x-3">
                    <FileText className="w-4 h-4 text-purple-400 mt-0.5" />
                    <div>
                      <p className="text-xs text-gray-600 dark:text-gray-400">Account Number</p>
                      <p className="text-sm font-semibold text-gray-900 dark:text-white">{accountInfo.accountNumber}</p>
                    </div>
                  </div>
                  <div className="flex items-start space-x-3">
                    <Gauge className="w-4 h-4 text-purple-400 mt-0.5" />
                    <div>
                      <p className="text-xs text-gray-600 dark:text-gray-400">Meter Number</p>
                      <p className="text-sm font-semibold text-gray-900 dark:text-white">{accountInfo.meterNumber}</p>
                    </div>
                  </div>
                  <div className="flex items-start space-x-3 md:col-span-2">
                    <MapPin className="w-4 h-4 text-purple-400 mt-0.5" />
                    <div>
                      <p className="text-xs text-gray-600 dark:text-gray-400">Service Address</p>
                      <p className="text-sm font-semibold text-gray-900 dark:text-white">{accountInfo.address}</p>
                    </div>
                  </div>
                  <div className="flex items-start space-x-3">
                    <Zap className="w-4 h-4 text-purple-400 mt-0.5" />
                    <div>
                      <p className="text-xs text-gray-600 dark:text-gray-400">Last Reading</p>
                      <p className="text-sm font-semibold text-gray-900 dark:text-white">{accountInfo.lastReading} kWh</p>
                    </div>
                  </div>
                  <div className="flex items-start space-x-3">
                    <Calendar className="w-4 h-4 text-purple-400 mt-0.5" />
                    <div>
                      <p className="text-xs text-gray-600 dark:text-gray-400">Last Reading Date</p>
                      <p className="text-sm font-semibold text-gray-900 dark:text-white">{accountInfo.lastReadingDate}</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Request Form */}
              <form onSubmit={handleSubmit} className="bg-white dark:bg-white/5 backdrop-blur-xl rounded-2xl p-5 border border-gray-200 dark:border-white/10 space-y-4">
                <h2 className="text-lg font-bold text-gray-900 dark:text-white mb-3">Reading Request Details</h2>

                {/* Request Type */}
                <div>
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    Request Type
                  </label>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {requestTypes.map((type) => (
                      <button
                        key={type.value}
                        type="button"
                        onClick={() => setFormData({ ...formData, requestType: type.value })}
                        className={`p-3 rounded-lg border transition-all text-left ${
                          formData.requestType === type.value
                            ? 'border-purple-400/50 bg-purple-500/10'
                            : 'border-gray-200 dark:border-white/10 hover:border-gray-300 dark:hover:border-white/20'
                        }`}
                      >
                        <p className="text-sm font-semibold text-gray-900 dark:text-white">{type.label}</p>
                        <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">{type.description}</p>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Urgency Level */}
                <div>
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    Priority Level
                  </label>
                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    {urgencyLevels.map((level) => (
                      <button
                        key={level.value}
                        type="button"
                        onClick={() => setFormData({ ...formData, urgency: level.value })}
                        className={`p-3 rounded-lg border transition-all text-center ${
                          formData.urgency === level.value
                            ? 'border-purple-400/50 bg-purple-500/10'
                            : 'border-gray-200 dark:border-white/10 hover:border-gray-300 dark:hover:border-white/20'
                        }`}
                      >
                        <div className={`w-8 h-8 bg-gradient-to-r ${level.color} rounded-lg flex items-center justify-center mx-auto mb-2`}>
                          <AlertCircle className="w-4 h-4 text-white" />
                        </div>
                        <p className="text-xs font-semibold text-gray-900 dark:text-white">{level.label}</p>
                        <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">{level.description}</p>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Preferred Date */}
                <div>
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    Preferred Date <span className="text-red-400">*</span>
                  </label>
                  <div className="relative">
                    <Calendar className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-600 dark:text-gray-400" />
                    <input
                      type="date"
                      required
                      value={formData.preferredDate}
                      onChange={(e) => setFormData({ ...formData, preferredDate: e.target.value })}
                      min={new Date().toISOString().split('T')[0]}
                      className="w-full pl-12 pr-4 py-3 bg-gray-50 dark:bg-white/10 border border-gray-300 dark:border-white/20 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-purple-400 transition-colors"
                    />
                  </div>
                </div>

                {/* Time Slot */}
                <div>
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    Preferred Time Slot
                  </label>
                  <select
                    value={formData.preferredTimeSlot}
                    onChange={(e) => setFormData({ ...formData, preferredTimeSlot: e.target.value })}
                    className="w-full px-4 py-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-white/20 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-purple-400 font-medium"
                  >
                    {timeSlots.map((slot) => (
                      <option key={slot.value} value={slot.value} className="bg-white dark:bg-gray-800 text-gray-900 dark:text-white py-2">
                        {slot.label}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Contact Phone */}
                <div>
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    Contact Phone <span className="text-red-400">*</span>
                  </label>
                  <div className="relative">
                    <Phone className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-600 dark:text-gray-400" />
                    <input
                      type="tel"
                      required
                      value={formData.contactPhone}
                      onChange={(e) => setFormData({ ...formData, contactPhone: e.target.value })}
                      className="w-full pl-12 pr-4 py-3 bg-gray-50 dark:bg-white/10 border border-gray-300 dark:border-white/20 rounded-lg text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:border-purple-400 transition-colors"
                      placeholder="+1 (555) 000-0000"
                    />
                  </div>
                </div>

                {/* Alternate Phone */}
                <div>
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    Alternate Phone (Optional)
                  </label>
                  <div className="relative">
                    <Phone className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-600 dark:text-gray-400" />
                    <input
                      type="tel"
                      value={formData.alternatePhone}
                      onChange={(e) => setFormData({ ...formData, alternatePhone: e.target.value })}
                      className="w-full pl-12 pr-4 py-3 bg-gray-50 dark:bg-white/10 border border-gray-300 dark:border-white/20 rounded-lg text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:border-purple-400 transition-colors"
                      placeholder="+1 (555) 000-0000"
                    />
                  </div>
                </div>

                {/* Access Instructions */}
                <div>
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    Access Instructions (Optional)
                  </label>
                  <textarea
                    value={formData.accessInstructions}
                    onChange={(e) => setFormData({ ...formData, accessInstructions: e.target.value })}
                    className="w-full px-4 py-3 bg-gray-50 dark:bg-white/10 border border-gray-300 dark:border-white/20 rounded-lg text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:border-purple-400 transition-colors resize-none"
                    rows={3}
                    placeholder="Provide any special instructions for accessing your meter (e.g., gate code, dog on premises, meter location details)"
                  />
                </div>

                {/* Submit Button */}
                <button
                  type="submit"
                  disabled={isSubmitting}
                  className={`w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold transition-all flex items-center justify-center space-x-2 ${
                    isSubmitting ? 'opacity-70 cursor-not-allowed' : 'hover:shadow-lg hover:shadow-purple-500/50'
                  }`}
                >
                  {isSubmitting ? (
                    <>
                      <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                      <span>Submitting Request...</span>
                    </>
                  ) : (
                    <>
                      <Send className="w-5 h-5" />
                      <span>Submit Reading Request</span>
                    </>
                  )}
                </button>
              </form>
            </div>

            {/* Right Column - Info & History */}
            <div className="space-y-4">
              {/* Important Notice */}
              <div className="bg-gradient-to-r from-blue-500/10 to-cyan-500/10 backdrop-blur-xl rounded-2xl p-5 border border-blue-500/20">
                <div className="flex items-center space-x-2 mb-3">
                  <AlertCircle className="w-5 h-5 text-blue-400" />
                  <h3 className="text-sm font-bold text-gray-900 dark:text-white">Important Information</h3>
                </div>
                <div className="space-y-2 text-xs text-gray-700 dark:text-gray-300">
                  <div className="flex items-start space-x-2">
                    <CheckCircle className="w-3 h-3 text-blue-400 mt-0.5 flex-shrink-0" />
                    <span>Reading requests are processed within 24 hours</span>
                  </div>
                  <div className="flex items-start space-x-2">
                    <CheckCircle className="w-3 h-3 text-blue-400 mt-0.5 flex-shrink-0" />
                    <span>You'll receive SMS and email notifications</span>
                  </div>
                  <div className="flex items-start space-x-2">
                    <CheckCircle className="w-3 h-3 text-blue-400 mt-0.5 flex-shrink-0" />
                    <span>Ensure meter is accessible on preferred date</span>
                  </div>
                  <div className="flex items-start space-x-2">
                    <CheckCircle className="w-3 h-3 text-blue-400 mt-0.5 flex-shrink-0" />
                    <span>Bill will be generated after reading is taken</span>
                  </div>
                </div>
              </div>

              {/* Previous Requests */}
              <div className="bg-white dark:bg-white/5 backdrop-blur-xl rounded-2xl p-5 border border-gray-200 dark:border-white/10">
                <h3 className="text-base font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                  <History className="w-4 h-4 mr-2" />
                  Previous Requests
                </h3>
                <div className="space-y-3">
                  {previousRequests.map((request) => (
                    <div
                      key={request.id}
                      className="p-3 bg-white dark:bg-white/5 rounded-lg border border-gray-200 dark:border-white/10"
                    >
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs font-semibold text-gray-900 dark:text-white">{request.requestNumber}</span>
                        <span className={`inline-flex items-center space-x-1 px-2 py-1 rounded-full text-xs font-semibold border ${getStatusColor(request.status)}`}>
                          {getStatusIcon(request.status)}
                          <span className="capitalize">{request.status.replace('_', ' ')}</span>
                        </span>
                      </div>
                      <div className="space-y-1 text-xs text-gray-600 dark:text-gray-400">
                        <div className="flex justify-between">
                          <span>Requested:</span>
                          <span className="text-gray-900 dark:text-white">{request.requestedDate}</span>
                        </div>
                        <div className="flex justify-between">
                          <span>Completed:</span>
                          <span className="text-gray-900 dark:text-white">{request.completedDate}</span>
                        </div>
                        <div className="flex justify-between">
                          <span>Reading Taken:</span>
                          <span className="text-green-400 font-semibold">{request.readingTaken} kWh</span>
                        </div>
                        <div className="flex justify-between">
                          <span>Employee:</span>
                          <span className="text-gray-900 dark:text-white">{request.assignedTo}</span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Need Help */}
              <div className="bg-gradient-to-r from-yellow-400/10 to-orange-500/10 backdrop-blur-xl rounded-2xl p-5 border border-yellow-400/20">
                <div className="flex items-center space-x-2 mb-3">
                  <Phone className="w-5 h-5 text-yellow-400" />
                  <h3 className="text-sm font-bold text-gray-900 dark:text-white">Need Help?</h3>
                </div>
                <p className="text-xs text-gray-700 dark:text-gray-300 mb-3">
                  Contact our customer service team for assistance with meter reading requests.
                </p>
                <div className="space-y-2 text-xs">
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 dark:text-gray-400">Phone:</span>
                    <span className="text-gray-900 dark:text-white font-semibold">1-800-ELECTRIC</span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 dark:text-gray-400">Hours:</span>
                    <span className="text-gray-900 dark:text-white font-semibold">24/7</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </DashboardLayout>
  );
}
